name: ShellCheck Modified Files

on:
  push:
    branches:
      - shellcheck-workflow
    paths:
      - "**/*.sh"

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Get changed files
        id: changed-files
        run: |
          files=$(git diff --name-only HEAD^ HEAD | grep '\.sh$' || echo "")
          echo "files=$files" >> $GITHUB_OUTPUT
        # $GITHUB_OUTPUT is used to set the "files" output for this step.

      - name: Run ShellCheck on changed files
        if: steps.changed-files.outputs.files != ''
        run: |
          echo "Checking files: ${{ steps.changed-files.outputs.files }}"
          for file in ${{ steps.changed-files.outputs.files }}; do
            echo "Checking $file..."
            if ! shellcheck "$file"; then
              echo "::error file=$file::ShellCheck found issues in $file"
              exit 1
            fi
          done
